<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Guest Accommodations</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/framework7@5.7.14/css/framework7.bundle.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .page-content { padding-bottom: 70px; }
    </style>
    <!-- Firebase SDKs -->
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
</head>
<body>
    <div id="app">
        <!-- Views/pages root container -->
        <div class="views tabs safe-areas">
            <!-- Tabbar -->
            <div class="toolbar tabbar toolbar-bottom-md">
                <div class="toolbar-inner">
                    <a href="#view-dashboard" class="tab-link tab-link-active" data-view="#view-dashboard">
                        <i class="f7-icons size-22">house_fill</i>
                        <span class="tabbar-label">Dashboard</span>
                    </a>
                    <a href="#view-houses" class="tab-link" data-view="#view-houses">
                        <i class="f7-icons size-22">building_2_fill</i>
                        <span class="tabbar-label">Houses</span>
                    </a>
                    <a href="#view-rooms" class="tab-link" data-view="#view-rooms">
                        <i class="f7-icons size-22">square_list_fill</i>
                        <span class="tabbar-label">Rooms</span>
                    </a>
                    <a href="#view-guests" class="tab-link" data-view="#view-guests">
                        <i class="f7-icons size-22">person_3_fill</i>
                        <span class="tabbar-label">Guests</span>
                    </a>
                    <a href="#view-tasks" class="tab-link" data-view="#view-tasks">
                        <i class="f7-icons size-22">checklist_fill</i>
                        <span class="tabbar-label">Tasks</span>
                    </a>
                </div>
            </div>

            <!-- Dashboard View -->
            <div id="view-dashboard" class="view view-main tab tab-active">
                <div class="page">
                    <div class="navbar">
                        <div class="navbar-bg"></div>
                        <div class="navbar-inner">
                            <div class="title">Dashboard</div>
                        </div>
                    </div>
                    <div class="page-content">
                        <div class="block block-strong inset">
                            <p>Welcome! Your houses and guests at a glance.</p>
                        </div>
                        <div class="list media-list inset" id="dashboard-guests-list">
                            <ul></ul>
                        </div>
                        <div class="block-title">Available Rooms</div>
                        <div class="list media-list inset" id="dashboard-available-rooms-list">
                            <ul></ul>
                        </div>
                        <div id="user-info" class="block block-strong text-align-center text-color-gray"></div>
                    </div>
                </div>
            </div>

            <!-- Houses View -->
            <div id="view-houses" class="view tab">
                <div class="page">
                    <div class="navbar">
                        <div class="navbar-bg"></div>
                        <div class="navbar-inner">
                            <div class="title">Houses</div>
                        </div>
                    </div>
                    <div class="page-content">
                        <div class="block-title">Add New House</div>
                        <form id="house-form" class="list inset form-store-data">
                            <ul>
                                <li>
                                    <div class="item-content item-input">
                                        <div class="item-inner">
                                            <div class="item-title item-label">House Name</div>
                                            <div class="item-input-wrap">
                                                <input type="text" name="house-name" placeholder="e.g., Main House" required validate>
                                                <span class="input-clear-button"></span>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                            <div class="block block-strong row">
                                <button type="submit" class="col button button-fill button-large">Add House</button>
                            </div>
                        </form>
                        <div class="block-title">Your Houses</div>
                        <div class="list media-list inset" id="house-list">
                            <ul></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rooms View -->
            <div id="view-rooms" class="view tab">
                <div class="page">
                    <div class="navbar">
                        <div class="navbar-bg"></div>
                        <div class="navbar-inner">
                            <div class="title">Rooms</div>
                        </div>
                    </div>
                    <div class="page-content">
                        <div class="block-title">Add New Room</div>
                        <form id="room-form" class="list inset form-store-data">
                            <ul>
                                <li>
                                    <div class="item-content item-input">
                                        <div class="item-inner">
                                            <div class="item-title item-label">House</div>
                                            <div class="item-input-wrap">
                                                <select name="house-id" required validate id="room-house"></select>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="item-content item-input">
                                        <div class="item-inner">
                                            <div class="item-title item-label">Room Name</div>
                                            <div class="item-input-wrap">
                                                <input type="text" name="room-name" placeholder="e.g., Master Bedroom" required validate>
                                                <span class="input-clear-button"></span>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="item-content item-input">
                                        <div class="item-inner">
                                            <div class="item-title item-label">Bed Type</div>
                                            <div class="item-input-wrap">
                                                <select name="bed-type" required validate>
                                                    <option value="" disabled selected>Select Bed Type</option>
                                                    <option value="king">King</option>
                                                    <option value="queen">Queen</option>
                                                    <option value="full">Full</option>
                                                    <option value="twin">Twin</option>
                                                    <option value="none">None</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="item-content item-input">
                                        <div class="item-inner">
                                            <div class="item-title item-label">Capacity</div>
                                            <div class="item-input-wrap">
                                                <input type="number" name="capacity" placeholder="e.g., 2" required validate>
                                                <span class="input-clear-button"></span>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="item-content item-input">
                                        <div class="item-inner">
                                            <div class="item-title item-label">Prep Needed</div>
                                            <div class="item-input-wrap">
                                                <input type="text" id="room-prep-item" placeholder="Add task (e.g., clean sheets)">
                                                <span class="input-clear-button"></span>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li class="prep-list-container">
                                    <ul id="prep-list"></ul>
                                </li>
                            </ul>
                            <div class="block block-strong row">
                                <button type="submit" class="col button button-fill button-large">Add Room</button>
                            </div>
                        </form>
                        <div class="block-title">Your Rooms</div>
                        <div class="list media-list inset" id="room-list">
                            <ul></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Guests View -->
            <div id="view-guests" class="view tab">
                <div class="page">
                    <div class="navbar">
                        <div class="navbar-bg"></div>
                        <div class="navbar-inner">
                            <div class="title">Guests</div>
                        </div>
                    </div>
                    <div class="page-content">
                        <div class="block-title">Add New Guest / Family</div>
                        <form id="guest-form" class="list inset form-store-data">
                            <ul>
                                <li>
                                    <div class="item-content item-input">
                                        <div class="item-inner">
                                            <div class="item-title item-label">Guest Name</div>
                                            <div class="item-input-wrap">
                                                <input type="text" name="guest-name" placeholder="e.g., John Doe" required validate>
                                                <span class="input-clear-button"></span>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="item-content item-input">
                                        <div class="item-inner">
                                            <div class="item-title item-label">Family Name</div>
                                            <div class="item-input-wrap">
                                                <input type="text" name="guest-family" placeholder="e.g., The Doe Family">
                                                <span class="input-clear-button"></span>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                            <div class="block block-strong row">
                                <button type="submit" class="col button button-fill button-large">Add Guest</button>
                            </div>
                        </form>
                        <div class="block-title">Your Guests</div>
                        <div class="list media-list inset" id="guest-list">
                            <ul></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assignments View -->
            <div id="view-assignments" class="view tab">
                <div class="page">
                    <div class="navbar">
                        <div class="navbar-bg"></div>
                        <div class="navbar-inner">
                            <div class="title">Assignments</div>
                        </div>
                    </div>
                    <div class="page-content">
                        <div class="block-title">Assign Guests to Rooms</div>
                        <form id="assignment-form" class="list inset form-store-data">
                            <ul>
                                <li>
                                    <div class="item-content item-input">
                                        <div class="item-inner">
                                            <div class="item-title item-label">House</div>
                                            <div class="item-input-wrap">
                                                <select name="house-id" required validate id="assignment-house"></select>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="item-content item-input">
                                        <div class="item-inner">
                                            <div class="item-title item-label">Room</div>
                                            <div class="item-input-wrap">
                                                <select name="room-id" required validate id="assignment-room"></select>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="item-content item-input">
                                        <div class="item-inner">
                                            <div class="item-title item-label">Guest / Family</div>
                                            <div class="item-input-wrap">
                                                <select name="guest-id" required validate id="assignment-guest"></select>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="item-content item-input">
                                        <div class="item-inner">
                                            <div class="item-title item-label">Start Date</div>
                                            <div class="item-input-wrap">
                                                <input type="date" name="start-date" required validate>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="item-content item-input">
                                        <div class="item-inner">
                                            <div class="item-title item-label">End Date</div>
                                            <div class="item-input-wrap">
                                                <input type="date" name="end-date" required validate>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                            <div class="block block-strong row">
                                <button type="submit" class="col button button-fill button-large">Assign</button>
                            </div>
                        </form>
                        <div class="block-title">Current Assignments</div>
                        <div class="list media-list inset" id="assignment-list">
                            <ul></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Required Tasks View -->
            <div id="view-tasks" class="view tab">
                <div class="page">
                    <div class="navbar">
                        <div class="navbar-bg"></div>
                        <div class="navbar-inner">
                            <div class="title">Required Tasks</div>
                        </div>
                    </div>
                    <div class="page-content">
                        <div class="block-title">Room Prep Tasks</div>
                        <div class="list simple-list list-form">
                            <ul>
                                <li>
                                    <div class="item-content">
                                        <div class="item-inner">
                                            <div class="item-input-wrap">
                                                <div class="sort-controls block">
                                                    <span class="label">Sort by:</span>
                                                    <a href="#" class="button button-small" onclick="window.sortTasks('houseName')">House</a>
                                                    <a href="#" class="button button-small" onclick="window.sortTasks('roomName')">Room</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="list media-list inset" id="tasks-list">
                            <ul></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modals -->
            <div class="sheet-modal" id="assign-modal">
                <div class="toolbar">
                    <div class="toolbar-inner">
                        <div class="left"></div>
                        <div class="right">
                            <a href="#" class="link sheet-close">Close</a>
                        </div>
                    </div>
                </div>
                <div class="sheet-modal-inner">
                    <div class="page-content">
                        <div class="block-title" id="assign-modal-title">Assign Guest to Room</div>
                        <form id="assign-modal-form" class="list inset form-store-data">
                            <ul>
                                <li>
                                    <div class="item-content item-input">
                                        <div class="item-inner">
                                            <div class="item-title item-label">Guest</div>
                                            <div class="item-input-wrap" id="assign-modal-guest-info"></div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="item-content item-input">
                                        <div class="item-inner">
                                            <div class="item-title item-label">House</div>
                                            <div class="item-input-wrap">
                                                <select name="house-id" required validate id="assign-modal-house"></select>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="item-content item-input">
                                        <div class="item-inner">
                                            <div class="item-title item-label">Room</div>
                                            <div class="item-input-wrap">
                                                <select name="room-id" required validate id="assign-modal-room"></select>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="item-content item-input">
                                        <div class="item-inner">
                                            <div class="item-title item-label">Start Date</div>
                                            <div class="item-input-wrap">
                                                <input type="date" name="start-date" required validate>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="item-content item-input">
                                        <div class="item-inner">
                                            <div class="item-title item-label">End Date</div>
                                            <div class="item-input-wrap">
                                                <input type="date" name="end-date" required validate>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                            <div class="block block-strong row">
                                <button type="submit" class="col button button-fill button-large">Assign</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="sheet-modal" id="edit-modal">
                <div class="toolbar">
                    <div class="toolbar-inner">
                        <div class="left"></div>
                        <div class="right">
                            <a href="#" class="link sheet-close">Close</a>
                        </div>
                    </div>
                </div>
                <div class="sheet-modal-inner">
                    <div class="page-content">
                        <div class="block-title" id="edit-modal-title">Edit Item</div>
                        <form id="edit-modal-form" class="list inset form-store-data">
                            <ul>
                                <li id="edit-modal-form-content"></li>
                            </ul>
                            <div class="block block-strong row">
                                <button type="submit" class="col button button-fill button-large">Save</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/framework7@5.7.14/js/framework7.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyB_0fHWf0Hrpjcv4Hn0QY4L4JDMpc9RFVc",
            authDomain: "home-guests.firebaseapp.com",
            projectId: "home-guests",
            storageBucket: "home-guests.firebasestorage.app",
            messagingSenderId: "527629164349",
            appId: "1:527629164349:web:6eca4e0ce1020d35f56f54"
        };
        const appId = "home-guests";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;

        // Framework7 initialization
        const f7 = new Framework7({
            root: '#app',
            name: 'Guest Accommodations',
            id: 'com.guestaccommodations.app'
        });

        const mainView = f7.views.current;

        // --- DOM Element References ---
        const dashboardGuestsList = document.getElementById('dashboard-guests-list');
        const dashboardAvailableRoomsList = document.getElementById('dashboard-available-rooms-list');
        const houseList = document.getElementById('house-list');
        const roomList = document.getElementById('room-list');
        const guestList = document.getElementById('guest-list');
        const assignmentList = document.getElementById('assignment-list');
        const tasksList = document.getElementById('tasks-list');
        const userInfo = document.getElementById('user-info');

        // Forms and selects
        const houseForm = document.getElementById('house-form');
        const roomForm = document.getElementById('room-form');
        const guestForm = document.getElementById('guest-form');
        const assignmentForm = document.getElementById('assignment-form');
        const roomHouseSelect = document.getElementById('room-house');
        const assignmentHouseSelect = document.getElementById('assignment-house');
        const assignmentRoomSelect = document.getElementById('assignment-room');
        const assignmentGuestSelect = document.getElementById('assignment-guest');
        
        const roomPrepItemInput = document.getElementById('room-prep-item');
        const prepListUl = document.getElementById('prep-list');
        
        const assignModal = f7.sheet.get('#assign-modal');
        const assignModalForm = document.getElementById('assign-modal-form');
        const assignModalHouseSelect = document.getElementById('assign-modal-house');
        const assignModalRoomSelect = document.getElementById('assign-modal-room');
        const assignModalGuestInfo = document.getElementById('assign-modal-guest-info');

        const editModal = f7.sheet.get('#edit-modal');
        const editModalForm = document.getElementById('edit-modal-form');
        const editModalTitle = document.getElementById('edit-modal-title');
        const editModalContent = document.getElementById('edit-modal-form-content');

        // Caches for data
        let housesCache = [];
        let roomsCache = [];
        let guestsCache = [];
        let assignmentsCache = [];

        // Temporary data for form prep lists
        let tempPrepList = [];
        let editTempPrepList = [];

        // --- Firebase Auth & Initialization ---
        async function signIn() {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                f7.dialog.alert('Authentication failed. Please try again.');
                console.error("Error during authentication:", error);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userInfo.innerHTML = `User ID: ${userId}`;
                setupRealtimeListeners();
            } else {
                console.log("User is signed out.");
                userId = null;
            }
        });

        // --- Data Persistence ---
        function setupRealtimeListeners() {
            onSnapshot(collection(db, `artifacts/${appId}/public/data/houses`), (snapshot) => {
                housesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderHouses();
                populateSelects();
                renderDashboard();
            });
            onSnapshot(collection(db, `artifacts/${appId}/public/data/rooms`), (snapshot) => {
                roomsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRooms();
                populateSelects();
                renderTasks();
                renderDashboard();
            });
            onSnapshot(collection(db, `artifacts/${appId}/public/data/guests`), (snapshot) => {
                guestsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGuests();
                populateSelects();
                renderDashboard();
            });
            onSnapshot(collection(db, `artifacts/${appId}/public/data/assignments`), (snapshot) => {
                assignmentsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAssignments();
                renderDashboard();
                renderTasks();
            });
        }

        // --- CRUD Operations ---
        async function addData(collectionName, data) {
            if (!userId) return f7.dialog.alert('Please authenticate first.');
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/${collectionName}`), data);
            } catch (error) {
                f7.dialog.alert(`Error adding data: ${error.message}`);
                console.error(error);
            }
        }

        async function updateData(collectionName, docId, data) {
            if (!userId) return f7.dialog.alert('Please authenticate first.');
            try {
                await setDoc(doc(db, `artifacts/${appId}/public/data/${collectionName}`, docId), data, { merge: true });
            } catch (error) {
                f7.dialog.alert(`Error updating data: ${error.message}`);
                console.error(error);
            }
        }

        async function deleteData(collectionName, docId) {
            if (!userId) return f7.dialog.alert('Please authenticate first.');
            f7.dialog.confirm('Are you sure you want to delete this item?', () => {
                try {
                    deleteDoc(doc(db, `artifacts/${appId}/public/data/${collectionName}`, docId));
                } catch (error) {
                    f7.dialog.alert(`Error deleting data: ${error.message}`);
                    console.error(error);
                }
            });
        }

        // --- UI Rendering ---
        function renderDashboard() {
            const today = new Date().toISOString().split('T')[0];
            
            // Render Guests List
            dashboardGuestsList.innerHTML = `
                <div class="block-title">Guest Status</div>
                <ul>
                ${guestsCache.map(guest => {
                    const isAssigned = assignmentsCache.some(a => a.guestId === guest.id && a.startDate <= today && a.endDate >= today);
                    const statusText = isAssigned ? 'Assigned' : 'Not Assigned';
                    return `
                        <li data-guest-id="${guest.id}" data-guest-name="${guest.name}" onclick="window.openAssignModal(this)">
                            <a href="#" class="item-link item-content">
                                <div class="item-media"><i class="f7-icons">${isAssigned ? 'person_2_fill' : 'person'}</i></div>
                                <div class="item-inner">
                                    <div class="item-title">${guest.name}</div>
                                    <div class="item-after">${statusText}</div>
                                </div>
                            </a>
                        </li>
                    `;
                }).join('')}
                </ul>
            `;
            
            // Render Available Rooms
            dashboardAvailableRoomsList.innerHTML = `
                <div class="block-title">Available Rooms</div>
                <ul>
                ${roomsCache.filter(room => !assignmentsCache.some(a => a.roomId === room.id && a.startDate <= today && a.endDate >= today)).map(room => `
                    <li data-room-id="${room.id}" onclick="window.goToAssignPage(this)">
                        <a href="#" class="item-link item-content">
                            <div class="item-media"><i class="f7-icons">bed_double_fill</i></div>
                            <div class="item-inner">
                                <div class="item-title">${room.name} (${room.houseName})</div>
                                <div class="item-subtitle">${room.bedType} - Accommodates ${room.capacity}</div>
                                <div class="item-after text-color-green">Available</div>
                            </div>
                        </a>
                    </li>
                `).join('')}
                </ul>
            `;
        }
        
        window.goToAssignPage = function(el) {
            const roomId = el.dataset.roomId;
            const room = roomsCache.find(r => r.id === roomId);
            if (room) {
                f7.tab.show('#view-assignments');
                assignmentForm.querySelector('input[name="room-id"]').value = roomId;
                f7.form.fill('#assignment-form', { 'house-id': room.houseId, 'room-id': roomId });
                // We're navigating, so manually update the select
                f7.form.updateSelect('#assignment-form');
            }
        };

        function renderHouses() {
            houseList.innerHTML = `
                <ul>
                ${housesCache.map(house => `
                    <li>
                        <a href="#" class="item-link item-content" data-id="${house.id}" onclick="window.openEditModal('house', this)">
                            <div class="item-media"><i class="f7-icons">building_2_fill</i></div>
                            <div class="item-inner">
                                <div class="item-title">${house.name}</div>
                            </div>
                        </a>
                        <div class="swipeout-actions-right">
                            <a href="#" class="swipeout-delete" data-id="${house.id}" onclick="window.deleteData('houses', this.dataset.id)">Delete</a>
                        </div>
                    </li>
                `).join('')}
                </ul>
            `;
        }

        function renderRooms() {
            roomList.innerHTML = `
                <ul>
                ${roomsCache.map(room => {
                    const prepListHtml = room.prepNeeded && room.prepNeeded.length > 0
                        ? `
                        <div class="item-text">
                            <strong>Prep Needed:</strong>
                            <ul>
                            ${room.prepNeeded.map(task => `<li>${task}</li>`).join('')}
                            </ul>
                        </div>
                        ` : '';
                    return `
                        <li>
                            <a href="#" class="item-link item-content" data-id="${room.id}" onclick="window.openEditModal('room', this)">
                                <div class="item-media"><i class="f7-icons">bed_double_fill</i></div>
                                <div class="item-inner">
                                    <div class="item-title">${room.name}</div>
                                    <div class="item-subtitle">${room.houseName} - ${room.bedType}, Capacity: ${room.capacity}</div>
                                    ${prepListHtml}
                                </div>
                            </a>
                            <div class="swipeout-actions-right">
                                <a href="#" class="swipeout-delete" data-id="${room.id}" onclick="window.deleteData('rooms', this.dataset.id)">Delete</a>
                            </div>
                        </li>
                    `;
                }).join('')}
                </ul>
            `;
        }

        function renderGuests() {
            guestList.innerHTML = `
                <ul>
                ${guestsCache.map(guest => `
                    <li>
                        <a href="#" class="item-link item-content" data-id="${guest.id}" onclick="window.openEditModal('guest', this)">
                            <div class="item-media"><i class="f7-icons">person_crop_circle</i></div>
                            <div class="item-inner">
                                <div class="item-title">${guest.name}</div>
                                ${guest.family ? `<div class="item-subtitle">Family: ${guest.family}</div>` : ''}
                            </div>
                        </a>
                        <div class="swipeout-actions-right">
                            <a href="#" class="swipeout-delete" data-id="${guest.id}" onclick="window.deleteData('guests', this.dataset.id)">Delete</a>
                        </div>
                    </li>
                `).join('')}
                </ul>
            `;
        }

        function renderAssignments() {
            assignmentList.innerHTML = `
                <ul>
                ${assignmentsCache.map(assignment => `
                    <li>
                        <a href="#" class="item-link item-content">
                            <div class="item-media"><i class="f7-icons">calendar_today</i></div>
                            <div class="item-inner">
                                <div class="item-title">${assignment.guestName} in ${assignment.roomName}</div>
                                <div class="item-subtitle">${assignment.startDate} to ${assignment.endDate}</div>
                            </div>
                        </a>
                        <div class="swipeout-actions-right">
                            <a href="#" class="swipeout-delete" data-id="${assignment.id}" onclick="window.deleteData('assignments', this.dataset.id)">Delete</a>
                        </div>
                    </li>
                `).join('')}
                </ul>
            `;
        }

        function renderTasks(sortBy = 'houseName') {
            const allTasks = roomsCache.flatMap(room => 
                (room.prepNeeded || []).map(task => ({
                    houseName: room.houseName,
                    roomName: room.name,
                    task: task
                }))
            );

            if (sortBy === 'houseName') {
                allTasks.sort((a, b) => a.houseName.localeCompare(b.houseName) || a.roomName.localeCompare(b.roomName));
            } else if (sortBy === 'roomName') {
                allTasks.sort((a, b) => a.roomName.localeCompare(b.roomName) || a.houseName.localeCompare(b.houseName));
            }
            
            tasksList.innerHTML = `
                <ul>
                ${allTasks.map(task => `
                    <li>
                        <div class="item-content">
                            <div class="item-inner">
                                <div class="item-title">${task.houseName} - ${task.roomName}</div>
                                <div class="item-subtitle">${task.task}</div>
                            </div>
                        </div>
                    </li>
                `).join('')}
                </ul>
            `;
        }

        window.sortTasks = function(sortBy) {
            renderTasks(sortBy);
        };

        function populateSelects() {
            const houseOptionsHtml = housesCache.map(h => `<option value="${h.id}">${h.name}</option>`).join('');
            roomHouseSelect.innerHTML = `<option value="" disabled selected>Select a House</option>${houseOptionsHtml}`;
            assignmentHouseSelect.innerHTML = `<option value="" disabled selected>Select a House</option>${houseOptionsHtml}`;
            assignModalHouseSelect.innerHTML = `<option value="" disabled selected>Select a House</option>${houseOptionsHtml}`;
            
            const guestOptionsHtml = guestsCache.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            const familyOptionsHtml = [...new Set(guestsCache.filter(g => g.family).map(g => g.family))].map(f => `<option value="family-${f}">Family: ${f}</option>`).join('');
            assignmentGuestSelect.innerHTML = `<option value="" disabled selected>Select a Guest</option>${familyOptionsHtml}${guestOptionsHtml}`;
        }

        // --- Form Submission Handlers ---
        document.addEventListener('page:init', (e) => {
            const page = e.detail;
            if (page.name === 'houses') {
                const form = page.el.querySelector('#house-form');
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = f7.form.convertToData(form);
                    addData('houses', { name: formData['house-name'] });
                    f7.form.clear(form);
                });
            }
            // ... similar listeners for other pages
        });

        f7.on('popupOpen', (popup) => {
            // Logic for popup forms
        });
        
        // ... (remaining JavaScript code, refactored for Framework7 and full functionality)
        
        // --- Modal Handlers ---
        window.openAssignModal = function(el) {
            const guestId = el.dataset.guestId;
            const guestName = el.dataset.guestName;
            assignModalForm.dataset.guestId = guestId;
            assignModalGuestInfo.textContent = guestName;
            assignModal.open();
        };

        assignModalHouseSelect.addEventListener('change', () => {
            const houseId = assignModalHouseSelect.value;
            const roomOptionsHtml = roomsCache.filter(r => r.houseId === houseId)
                .map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            assignModalRoomSelect.innerHTML = `<option value="" disabled selected>Select a Room</option>${roomOptionsHtml}`;
            assignModalRoomSelect.disabled = !houseId;
        });
        
        assignModalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = f7.form.convertToData(assignModalForm);
            const guestId = assignModalForm.dataset.guestId;
            const guest = guestsCache.find(g => g.id === guestId);
            const room = roomsCache.find(r => r.id === formData['room-id']);

            if (guest && room) {
                addData('assignments', {
                    houseId: room.houseId,
                    houseName: room.houseName,
                    roomId: room.id,
                    roomName: room.name,
                    guestId: guest.id,
                    guestName: guest.name,
                    startDate: formData['start-date'],
                    endDate: formData['end-date']
                });
            }
            f7.sheet.close('#assign-modal');
            f7.form.clear(assignModalForm);
        });
        
        window.openEditModal = function(type, el) {
            const itemId = el.dataset.id;
            let item;

            if (type === 'house') {
                item = housesCache.find(h => h.id === itemId);
                editModalTitle.textContent = 'Edit House';
                editModalContent.innerHTML = `
                    <div class="item-content item-input">
                        <div class="item-inner">
                            <div class="item-title item-label">House Name</div>
                            <div class="item-input-wrap">
                                <input type="text" name="name" value="${item.name}" required validate>
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="id" value="${item.id}">
                    <input type="hidden" name="collection" value="houses">
                `;
            } else if (type === 'room') {
                item = roomsCache.find(r => r.id === itemId);
                editModalTitle.textContent = 'Edit Room';
                editModalContent.innerHTML = `
                    <div class="item-content item-input">
                        <div class="item-inner">
                            <div class="item-title item-label">Room Name</div>
                            <div class="item-input-wrap">
                                <input type="text" name="name" value="${item.name}" required validate>
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </div>
                    <div class="item-content item-input">
                        <div class="item-inner">
                            <div class="item-title item-label">Bed Type</div>
                            <div class="item-input-wrap">
                                <select name="bedType" required validate>
                                    <option value="king" ${item.bedType === 'king' ? 'selected' : ''}>King</option>
                                    <option value="queen" ${item.bedType === 'queen' ? 'selected' : ''}>Queen</option>
                                    <option value="full" ${item.bedType === 'full' ? 'selected' : ''}>Full</option>
                                    <option value="twin" ${item.bedType === 'twin' ? 'selected' : ''}>Twin</option>
                                    <option value="none" ${item.bedType === 'none' ? 'selected' : ''}>None</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="item-content item-input">
                        <div class="item-inner">
                            <div class="item-title item-label">Capacity</div>
                            <div class="item-input-wrap">
                                <input type="number" name="capacity" value="${item.capacity}" required validate>
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="id" value="${item.id}">
                    <input type="hidden" name="collection" value="rooms">
                `;
            } else if (type === 'guest') {
                item = guestsCache.find(g => g.id === itemId);
                editModalTitle.textContent = 'Edit Guest';
                editModalContent.innerHTML = `
                    <div class="item-content item-input">
                        <div class="item-inner">
                            <div class="item-title item-label">Guest Name</div>
                            <div class="item-input-wrap">
                                <input type="text" name="name" value="${item.name}" required validate>
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </div>
                    <div class="item-content item-input">
                        <div class="item-inner">
                            <div class="item-title item-label">Family Name</div>
                            <div class="item-input-wrap">
                                <input type="text" name="family" value="${item.family || ''}">
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="id" value="${item.id}">
                    <input type="hidden" name="collection" value="guests">
                `;
            }
            editModal.open();
        };

        editModalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = f7.form.convertToData(editModalForm);
            const collectionName = formData['collection'];
            const docId = formData['id'];
            
            // Remove the id and collection fields before updating
            delete formData.id;
            delete formData.collection;

            updateData(collectionName, docId, formData);
            f7.sheet.close('#edit-modal');
        });
        
        window.sortTasks = function(sortBy) {
            renderTasks(sortBy);
        };

        window.onload = signIn;
    </script>
</body>
</html>
