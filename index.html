<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guest Accommodations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    </style>
    <!-- Firebase SDKs -->
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
    <header class="bg-green-600 text-white p-4 text-center shadow-lg">
        <h1 class="text-2xl font-bold">House Guests</h1>
    </header>

    <nav class="flex flex-wrap justify-center bg-gray-700 p-2 gap-2">
        <button onclick="showSection('dashboard')" class="bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">Dashboard</button>
        <button onclick="showSection('houses')" class="bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">Houses</button>
        <button onclick="showSection('rooms')" class="bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">Rooms</button>
        <button onclick="showSection('guests')" class="bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">Guests</button>
        <button onclick="showSection('assignments')" class="bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">Assign Guests</button>
        <button onclick="showSection('reports')" class="bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">Reports</button>
    </nav>

    <main class="p-4 md:p-8 max-w-7xl mx-auto">
        <!-- Dashboard Section -->
        <section id="dashboard" class="bg-white p-6 md:p-8 rounded-xl shadow-lg transition-transform duration-300 transform hover:scale-105">
            <h2 class="text-2xl font-bold text-green-600 border-b-2 border-gray-200 pb-2 mb-4">Dashboard</h2>
            <div id="dashboard-tiles" class="grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8"></div>
            <div id="dashboard-guests-list" class="mt-8"></div>
            <div id="user-info" class="mt-6 text-sm text-gray-500"></div>
        </section>

        <!-- Houses Section -->
        <section id="houses" class="hidden bg-white p-6 md:p-8 rounded-xl shadow-lg transition-transform duration-300 transform hover:scale-105">
            <h2 class="text-2xl font-bold text-green-600 border-b-2 border-gray-200 pb-2 mb-4">Manage Houses</h2>
            <form id="house-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <input type="text" id="house-name" placeholder="House Name" required class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                <button type="submit" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors duration-200">Add House</button>
            </form>
            <ul id="house-list" class="space-y-3"></ul>
        </section>

        <!-- Rooms Section -->
        <section id="rooms" class="hidden bg-white p-6 md:p-8 rounded-xl shadow-lg transition-transform duration-300 transform hover:scale-105">
            <h2 class="text-2xl font-bold text-green-600 border-b-2 border-gray-200 pb-2 mb-4">Manage Rooms</h2>
            <form id="room-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <select id="room-house" required class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option value="" disabled selected>Select a House</option>
                </select>
                <input type="text" id="room-name" placeholder="Room Name (e.g., Master Bedroom)" required class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                <input type="number" id="room-capacity" placeholder="Capacity (e.g., 2)" required min="1" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                <select id="room-bed-type" required class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option value="" disabled selected>Select Bed Type</option>
                    <option value="king">King</option>
                    <option value="queen">Queen</option>
                    <option value="full">Full</option>
                    <option value="twin">Twin</option>
                    <option value="none">None</option>
                </select>
                <div class="col-span-1 md:col-span-2 bg-gray-100 rounded-lg p-4 -mt-4 mb-4">
                    <p class="font-medium mb-2">Prep Needed:</p>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="room-prep-item" placeholder="e.g., Buy new sheets" class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        <button type="button" onclick="addPrepItem()" class="bg-gray-400 text-white font-bold px-4 rounded-lg hover:bg-gray-500 transition-colors duration-200">Add</button>
                    </div>
                    <ul id="prep-list" class="list-disc list-inside space-y-1"></ul>
                </div>
                <button type="submit" class="col-span-1 md:col-span-2 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors duration-200">Add Room</button>
            </form>
            <div class="flex items-center gap-4 mb-4">
                <span class="font-medium">Sort by:</span>
                <button onclick="sortRooms('houseName')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-1 px-3 rounded-md transition-colors duration-200">House</button>
                <button onclick="sortRooms('name')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-1 px-3 rounded-md transition-colors duration-200">Room</button>
            </div>
            <ul id="room-list" class="space-y-3"></ul>
        </section>

        <!-- Guests Section -->
        <section id="guests" class="hidden bg-white p-6 md:p-8 rounded-xl shadow-lg transition-transform duration-300 transform hover:scale-105">
            <h2 class="text-2xl font-bold text-green-600 border-b-2 border-gray-200 pb-2 mb-4">Manage Guests & Families</h2>
            <form id="guest-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <input type="text" id="guest-name" placeholder="Guest's Name" required class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                <input type="text" id="guest-family" placeholder="Family Name (e.g., Smith Family)" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                <button type="submit" class="col-span-1 md:col-span-2 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors duration-200">Add Guest</button>
            </form>
            <ul id="guest-list" class="space-y-3"></ul>
        </section>

        <!-- Assignments Section -->
        <section id="assignments" class="hidden bg-white p-6 md:p-8 rounded-xl shadow-lg transition-transform duration-300 transform hover:scale-105">
            <h2 class="text-2xl font-bold text-green-600 border-b-2 border-gray-200 pb-2 mb-4">Assign Guests to Rooms</h2>
            <form id="assignment-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                <select id="assignment-house" required class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option value="" disabled selected>Select a House</option>
                </select>
                <select id="assignment-room" required disabled class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option value="" disabled selected>Select a Room</option>
                </select>
                <select id="assignment-guest" required class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option value="" disabled selected>Select a Guest</option>
                </select>
                <div class="col-span-1 md:col-span-2 lg:col-span-1">
                    <label for="assignment-start" class="block text-sm font-medium text-gray-700">Start Date:</label>
                    <input type="date" id="assignment-start" required class="mt-1 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 w-full">
                </div>
                <div class="col-span-1 md:col-span-2 lg:col-span-1">
                    <label for="assignment-end" class="block text-sm font-medium text-gray-700">End Date:</label>
                    <input type="date" id="assignment-end" required class="mt-1 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 w-full">
                </div>
                <button type="submit" class="col-span-1 md:col-span-2 lg:col-span-3 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors duration-200">Assign</button>
            </form>
            <ul id="assignment-list" class="space-y-3"></ul>
        </section>

        <!-- Reports Section -->
        <section id="reports" class="hidden bg-white p-6 md:p-8 rounded-xl shadow-lg transition-transform duration-300 transform hover:scale-105">
            <h2 class="text-2xl font-bold text-green-600 border-b-2 border-gray-200 pb-2 mb-4">Reports</h2>
            <div class="flex gap-4 mb-6">
                <button onclick="showReportView('list-view')" class="report-tab active-tab bg-green-600 text-white font-medium py-2 px-4 rounded-md">List View</button>
                <button onclick="showReportView('calendar-view')" class="report-tab bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-md">Calendar View</button>
            </div>

            <!-- List View Report -->
            <div id="list-view" class="report-content active-report">
                <h3 class="text-xl font-semibold mb-4">All Assignments</h3>
                <ul id="reports-list" class="space-y-3"></ul>
            </div>

            <!-- Calendar View Report -->
            <div id="calendar-view" class="report-content hidden-report hidden">
                <h3 class="text-xl font-semibold mb-4">Assignments (Calendar View)</h3>
                <div id="calendar-controls" class="flex items-center justify-between mb-4 bg-gray-100 p-2 rounded-lg">
                    <button onclick="prevMonth()" class="bg-gray-300 text-gray-800 px-3 py-1 rounded-md">&lt; Prev</button>
                    <h4 id="current-month-year" class="text-lg font-semibold"></h4>
                    <button onclick="nextMonth()" class="bg-gray-300 text-gray-800 px-3 py-1 rounded-md">Next &gt;</button>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center text-sm"></div>
            </div>
        </section>
    </main>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyB_0fHWf0Hrpjcv4Hn0QY4L4JDMpc9RFVc",
            authDomain: "home-guests.firebaseapp.com",
            projectId: "home-guests",
            storageBucket: "home-guests.firebasestorage.app",
            messagingSenderId: "527629164349",
            appId: "1:527629164349:web:6eca4e0ce1020d35f56f54"
        };
        const appId = "home-guests";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;

        // --- DOM Element References ---
        const sections = document.querySelectorAll('section');
        const houseForm = document.getElementById('house-form');
        const roomForm = document.getElementById('room-form');
        const guestForm = document.getElementById('guest-form');
        const assignmentForm = document.getElementById('assignment-form');
        const houseList = document.getElementById('house-list');
        const roomList = document.getElementById('room-list');
        const guestList = document.getElementById('guest-list');
        const assignmentList = document.getElementById('assignment-list');
        const reportsList = document.getElementById('reports-list');
        const calendarGrid = document.getElementById('calendar-grid');
        const currentMonthYear = document.getElementById('current-month-year');
        const roomHouseSelect = document.getElementById('room-house');
        const assignmentHouseSelect = document.getElementById('assignment-house');
        const assignmentRoomSelect = document.getElementById('assignment-room');
        const assignmentGuestSelect = document.getElementById('assignment-guest');
        const dashboardTiles = document.getElementById('dashboard-tiles');
        const dashboardGuestsList = document.getElementById('dashboard-guests-list');
        const userInfo = document.getElementById('user-info');
        const roomPrepItemInput = document.getElementById('room-prep-item');
        const prepListUl = document.getElementById('prep-list');

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let tempPrepList = []; 
        let roomsCache = [];
        let guestsCache = [];
        let assignmentsCache = [];

        // --- Firebase Auth & Initialization ---
        async function signIn() {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Error during authentication:", error);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userInfo.innerHTML = `<strong>User ID:</strong> ${userId}`;
                loadData();
            } else {
                console.log("User is signed out.");
                userId = null;
            }
        });

        // --- UI Functions ---
        window.showSection = function(sectionId) {
            sections.forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            if (sectionId === 'reports') {
                renderReports();
                showReportView('list-view');
            }
            if (sectionId === 'dashboard') {
                renderDashboard();
            }
        };

        window.showReportView = function(viewId) {
            document.querySelectorAll('.report-content').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');

            document.querySelectorAll('.report-tab').forEach(button => {
                button.classList.remove('active-tab', 'bg-green-600', 'text-white');
                button.classList.add('bg-gray-200', 'text-gray-800');
            });
            document.querySelector(`button[onclick="showReportView('${viewId}')"]`).classList.add('active-tab', 'bg-green-600', 'text-white');
            document.querySelector(`button[onclick="showReportView('${viewId}')"]`).classList.remove('bg-gray-200', 'text-gray-800');

            if (viewId === 'calendar-view') {
                renderCalendar();
            }
        };

        // --- Firestore CRUD Operations ---
        async function addData(collectionName, data) {
            if (!userId) {
                console.error("User not authenticated.");
                return;
            }
            try {
                const colRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
                await addDoc(colRef, data);
                console.log(`Added data to ${collectionName}.`);
            } catch (error) {
                console.error(`Error adding data to ${collectionName}:`, error);
            }
        }

        async function deleteData(collectionName, docId) {
            if (!userId) {
                console.error("User not authenticated.");
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/${collectionName}`, docId);
                await deleteDoc(docRef);
                console.log(`Deleted data from ${collectionName}.`);
            } catch (error) {
                console.error(`Error deleting data from ${collectionName}:`, error);
            }
        }

        // --- Data Loading & Real-time Updates ---
        function loadData() {
            if (!userId) return;
            setupRealtimeListeners();
        }

        function setupRealtimeListeners() {
            // Houses
            onSnapshot(collection(db, `artifacts/${appId}/public/data/houses`), (snapshot) => {
                houseList.innerHTML = '';
                snapshot.forEach(doc => {
                    const item = { id: doc.id, ...doc.data() };
                    const li = document.createElement('li');
                    li.className = 'bg-gray-50 p-4 rounded-lg shadow border-l-4 border-green-500 flex justify-between items-center';
                    li.innerHTML = `<span>üè° ${item.name}</span> <button class="bg-red-500 text-white text-sm py-1 px-3 rounded-md hover:bg-red-600 transition-colors duration-200" onclick="deleteDataWrapper('houses', '${item.id}')">Delete</button>`;
                    houseList.appendChild(li);
                });
                populateSelects();
            });

            // Rooms
            onSnapshot(collection(db, `artifacts/${appId}/public/data/rooms`), (snapshot) => {
                roomsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRooms(roomsCache);
                populateSelects();
            });

            // Guests
            onSnapshot(collection(db, `artifacts/${appId}/public/data/guests`), (snapshot) => {
                guestList.innerHTML = '';
                guestsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                guestsCache.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'bg-gray-50 p-4 rounded-lg shadow border-l-4 border-green-500 flex justify-between items-center';
                    li.innerHTML = `<span>üë§ ${item.name} ${item.family ? `(Family: ${item.family})` : ''}</span> <button class="bg-red-500 text-white text-sm py-1 px-3 rounded-md hover:bg-red-600 transition-colors duration-200" onclick="deleteDataWrapper('guests', '${item.id}')">Delete</button>`;
                    guestList.appendChild(li);
                });
                populateSelects();
            });

            // Assignments
            onSnapshot(collection(db, `artifacts/${appId}/public/data/assignments`), (snapshot) => {
                assignmentsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                assignmentList.innerHTML = '';
                assignmentsCache.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                assignmentsCache.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'bg-gray-50 p-4 rounded-lg shadow border-l-4 border-green-500 flex justify-between items-center';
                    li.innerHTML = `<span>üóìÔ∏è ${item.guestName} staying in ${item.roomName} at ${item.houseName} from ${item.startDate} to ${item.endDate}.</span> <button class="bg-red-500 text-white text-sm py-1 px-3 rounded-md hover:bg-red-600 transition-colors duration-200" onclick="deleteDataWrapper('assignments', '${item.id}')">Delete</button>`;
                    assignmentList.appendChild(li);
                });
                renderReports();
                renderCalendar();
                renderDashboard();
            });
        }
        
        window.deleteDataWrapper = function(collectionName, docId) {
            deleteData(collectionName, docId);
        };

        window.addPrepItem = function() {
            const item = roomPrepItemInput.value.trim();
            if (item) {
                tempPrepList.push(item);
                roomPrepItemInput.value = '';
                renderTempPrepList();
            }
        };

        window.removePrepItem = function(index) {
            tempPrepList.splice(index, 1);
            renderTempPrepList();
        };

        function renderTempPrepList() {
            prepListUl.innerHTML = '';
            tempPrepList.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-gray-200 p-2 rounded-md';
                li.innerHTML = `
                    <span>${item}</span>
                    <button type="button" onclick="removePrepItem(${index})" class="text-red-500 hover:text-red-700 font-bold ml-2 transition-colors duration-200">
                        &times;
                    </button>
                `;
                prepListUl.appendChild(li);
            });
        }
        
        async function populateSelects() {
            if (!userId) return;

            roomHouseSelect.innerHTML = '<option value="" disabled selected>Select a House</option>';
            assignmentHouseSelect.innerHTML = '<option value="" disabled selected>Select a House</option>';
            assignmentRoomSelect.innerHTML = '<option value="" disabled selected>Select a Room</option>';
            assignmentGuestSelect.innerHTML = '<option value="" disabled selected>Select a Guest</option>';
            assignmentRoomSelect.disabled = true;

            try {
                const housesSnap = await getDocs(collection(db, `artifacts/${appId}/public/data/houses`));
                housesSnap.forEach(doc => {
                    const house = { id: doc.id, ...doc.data() };
                    const option1 = new Option(house.name, house.id);
                    const option2 = new Option(house.name, house.id);
                    roomHouseSelect.add(option1);
                    assignmentHouseSelect.add(option2);
                });

                const guestsSnap = await getDocs(collection(db, `artifacts/${appId}/public/data/guests`));
                guestsSnap.forEach(doc => {
                    const guest = { id: doc.id, ...doc.data() };
                    const option = new Option(guest.name, doc.id);
                    assignmentGuestSelect.add(option);
                });
            } catch (error) {
                console.error("Error populating selects:", error);
            }
        }

        houseForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('house-name').value;
            addData('houses', { name });
            e.target.reset();
        });

        roomForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const houseId = document.getElementById('room-house').value;
            const name = document.getElementById('room-name').value;
            const capacity = parseInt(document.getElementById('room-capacity').value);
            const bedType = document.getElementById('room-bed-type').value;

            try {
                const house = roomsCache.find(r => r.id === houseId) || { houseName: 'Unknown' };
                addData('rooms', { houseId, houseName: house.houseName, name, capacity, bedType, prepNeeded: tempPrepList });
                e.target.reset();
                tempPrepList = []; 
                renderTempPrepList();
                document.getElementById('room-house').value = "";
            } catch (error) {
                console.error("Error adding room:", error);
            }
        });

        guestForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('guest-name').value;
            const family = document.getElementById('guest-family').value;
            addData('guests', { name, family });
            e.target.reset();
        });

        assignmentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const houseId = document.getElementById('assignment-house').value;
            const roomId = document.getElementById('assignment-room').value;
            const guestId = document.getElementById('assignment-guest').value;
            const startDate = document.getElementById('assignment-start').value;
            const endDate = document.getElementById('assignment-end').value;

            try {
                const room = roomsCache.find(r => r.id === roomId);
                const guest = guestsCache.find(g => g.id === guestId);

                if (room && guest) {
                    addData('assignments', { houseId, houseName: room.houseName, roomId, roomName: room.name, guestId, guestName: guest.name, startDate, endDate });
                    e.target.reset();
                    assignmentRoomSelect.disabled = true;
                    assignmentRoomSelect.innerHTML = '<option value="" disabled selected>Select a Room</option>';
                }
            } catch (error) {
                console.error("Error adding assignment:", error);
            }
        });

        assignmentHouseSelect.addEventListener('change', async (e) => {
            const houseId = e.target.value;
            assignmentRoomSelect.disabled = false;
            assignmentRoomSelect.innerHTML = '<option value="" disabled selected>Select a Room</option>';

            const filteredRooms = roomsCache.filter(room => room.houseId === houseId);
            filteredRooms.forEach(room => {
                const option = new Option(room.name, room.id);
                assignmentRoomSelect.add(option);
            });
        });
        
        let currentRoomsData = [];

        async function renderRooms(roomsData) {
            currentRoomsData = roomsData;
            sortRooms('houseName'); 
        }

        window.sortRooms = function(sortBy) {
            roomList.innerHTML = '';
            
            let sortedData = [...currentRoomsData];

            if (sortBy === 'houseName') {
                sortedData.sort((a, b) => a.houseName.localeCompare(b.houseName) || a.name.localeCompare(b.name));
            } else if (sortBy === 'name') {
                sortedData.sort((a, b) => a.name.localeCompare(b.name) || a.houseName.localeCompare(b.houseName));
            }
            
            sortedData.forEach(item => {
                const li = document.createElement('li');
                li.className = 'bg-gray-50 p-4 rounded-lg shadow border-l-4 border-green-500';
                let prepListHtml = '';
                if (item.prepNeeded && item.prepNeeded.length > 0) {
                    prepListHtml = `
                        <br><strong class="font-semibold text-gray-700">Prep Needed:</strong>
                        <ul class="list-disc list-inside mt-1 ml-4">${item.prepNeeded.map(prep => `<li>${prep}</li>`).join('')}</ul>
                    `;
                }
                li.innerHTML = `
                    <div class="flex items-center justify-between w-full">
                        <span>
                            üö™ <strong class="text-lg">${item.name}</strong> (${item.houseName})
                            <br>Capacity: ${item.capacity}, Bed: ${item.bedType}
                            ${prepListHtml}
                        </span>
                        <button class="bg-red-500 text-white text-sm py-1 px-3 rounded-md hover:bg-red-600 transition-colors duration-200" onclick="deleteDataWrapper('rooms', '${item.id}')">Delete</button>
                    </div>
                `;
                roomList.appendChild(li);
            });
        };

        async function renderDashboard() {
            if (!userId) return;
            const today = new Date().toISOString().split('T')[0];
            dashboardTiles.innerHTML = ''; 
            dashboardGuestsList.innerHTML = ''; 

            try {
                const houses = (await getDocs(collection(db, `artifacts/${appId}/public/data/houses`))).docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const rooms = (await getDocs(collection(db, `artifacts/${appId}/public/data/rooms`))).docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const assignments = (await getDocs(collection(db, `artifacts/${appId}/public/data/assignments`))).docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const guests = (await getDocs(collection(db, `artifacts/${appId}/public/data/guests`))).docs.map(doc => ({ id: doc.id, ...doc.data() }));

                houses.forEach(house => {
                    const houseTile = document.createElement('div');
                    houseTile.className = 'bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-500';
                    houseTile.innerHTML = `<h3 class="text-xl font-bold text-green-700 mb-4">üè° ${house.name}</h3><div class="space-y-4"></div>`;
                    const roomGrid = houseTile.querySelector('div');

                    const houseRooms = rooms.filter(room => room.houseId === house.id);

                    houseRooms.forEach(room => {
                        const roomTile = document.createElement('div');
                        roomTile.className = 'bg-gray-50 p-4 rounded-lg shadow border-l-4 border-gray-300';
                        
                        const activeAssignment = assignments.find(a => 
                            a.roomId === room.id && a.startDate <= today && a.endDate >= today
                        );
                        
                        let statusHtml = '';
                        if (activeAssignment) {
                            roomTile.classList.remove('border-gray-300');
                            roomTile.classList.add('border-red-500');
                            statusHtml = `<p class="font-semibold text-red-700">Occupied by: <span class="font-bold text-gray-800">${activeAssignment.guestName}</span></p>`;
                        } else {
                            roomTile.classList.remove('border-gray-300');
                            roomTile.classList.add('border-green-500');
                            statusHtml = `<p class="font-semibold text-green-700">Status: <span class="font-bold text-gray-800">Available</span></p>`;
                            statusHtml += `<p class="text-sm text-gray-600">Capacity: ${room.capacity}, Bed: ${room.bedType}</p>`;
                        }

                        roomTile.innerHTML = `
                            <h4 class="font-bold text-lg mb-1">${room.name}</h4>
                            ${statusHtml}
                        `;
                        roomGrid.appendChild(roomTile);
                    });

                    dashboardTiles.appendChild(houseTile);
                });

                const guestListContainer = document.createElement('div');
                guestListContainer.innerHTML = '<h3 class="text-xl font-bold text-green-600 border-b-2 border-gray-200 pb-2 mb-4">Guest Status</h3><ul class="grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></ul>';
                const guestUl = guestListContainer.querySelector('ul');
                guests.forEach(guest => {
                    const li = document.createElement('li');
                    li.className = 'bg-gray-50 p-4 rounded-lg shadow flex justify-between items-center';
                    
                    const isAssigned = assignments.some(a => a.guestId === guest.id && a.startDate <= today && a.endDate >= today);
                    
                    const statusClass = isAssigned ? 'bg-green-500' : 'bg-red-500';
                    const statusText = isAssigned ? 'Assigned' : 'Not Assigned';
                    
                    li.innerHTML = `
                        <span class="font-medium text-gray-800">${guest.name}</span>
                        <span class="py-1 px-3 text-white text-xs font-bold rounded-full ${statusClass}">${statusText}</span>
                    `;
                    guestUl.appendChild(li);
                });
                dashboardGuestsList.appendChild(guestListContainer);

            } catch (error) {
                console.error("Error rendering dashboard:", error);
            }
        }

        async function renderReports() {
            if (!userId) return;
            reportsList.innerHTML = '';
            try {
                const assignmentsSnap = await getDocs(collection(db, `artifacts/${appId}/public/data/assignments`));
                const assignments = assignmentsSnap.docs.map(doc => doc.data());
                assignments.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                assignments.forEach(assignment => {
                    const li = document.createElement('li');
                    li.className = 'bg-gray-50 p-4 rounded-lg shadow border-l-4 border-green-500';
                    li.innerHTML = `<strong class="font-semibold text-gray-800">${assignment.guestName}</strong> is staying in <strong class="text-gray-800">${assignment.roomName}</strong> at <strong class="text-gray-800">${assignment.houseName}</strong> from ${assignment.startDate} to ${assignment.endDate}.`;
                    reportsList.appendChild(li);
                });
            } catch (error) {
                console.error("Error rendering reports:", error);
            }
        }

        async function renderCalendar() {
            if (!userId) return;
            calendarGrid.innerHTML = '';
            currentMonthYear.textContent = `${new Date(currentYear, currentMonth).toLocaleString('default', { month: 'long' })} ${currentYear}`;

            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            daysOfWeek.forEach(day => {
                const header = document.createElement('div');
                header.className = 'font-bold text-gray-600 p-2';
                header.textContent = day;
                calendarGrid.appendChild(header);
            });

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'p-2 bg-gray-200 rounded-md';
                calendarGrid.appendChild(dayDiv);
            }

            try {
                const assignments = assignmentsCache;
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'p-2 border border-gray-300 rounded-md bg-white min-h-[100px] flex flex-col items-start';
                    if (new Date(currentYear, currentMonth, i).toISOString().split('T')[0] === todayStr) {
                        dayDiv.classList.add('bg-green-100', 'border-green-500');
                    }
                    
                    const dayNum = document.createElement('h5');
                    dayNum.textContent = i;
                    dayNum.className = 'font-bold text-lg mb-1';
                    dayDiv.appendChild(dayNum);

                    const currentDate = new Date(currentYear, currentMonth, i).toISOString().split('T')[0];

                    assignments.forEach(assignment => {
                        if (currentDate >= assignment.startDate && currentDate <= assignment.endDate) {
                            const assignmentItem = document.createElement('div');
                            assignmentItem.className = 'text-xs text-gray-800 bg-green-200 px-2 py-1 rounded-full mb-1 overflow-hidden whitespace-nowrap text-ellipsis w-full';
                            assignmentItem.textContent = `${assignment.guestName}`;
                            dayDiv.appendChild(assignmentItem);
                        }
                    });
                    calendarGrid.appendChild(dayDiv);
                }
            } catch (error) {
                console.error("Error rendering calendar:", error);
            }
        }

        window.prevMonth = function() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        };

        window.nextMonth = function() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        };

        window.onload = signIn;
    </script>
</body>
</html>
