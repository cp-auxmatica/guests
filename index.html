<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guest Accommodations</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }
        
        header {
            background-color: #4CAF50;
            color: white;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        nav {
            display: flex;
            justify-content: center;
            background-color: #555;
            padding: 0.5rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        nav button {
            background-color: #666;
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        
        nav button:hover {
            background-color: #888;
            transform: translateY(-2px);
        }
        
        main {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        section {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        section:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }
        
        .hidden {
            display: none;
        }
        
        h2 {
            color: #4CAF50;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        form input, form select, form textarea {
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
        }
        
        form button {
            grid-column: 1 / -1;
            background-color: #4CAF50;
            color: white;
            padding: 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s ease;
        }
        
        form button:hover {
            background-color: #45a049;
        }
        
        ul {
            list-style: none;
            padding: 0;
        }
        
        li {
            background-color: #f9f9f9;
            padding: 1.25rem;
            margin-bottom: 0.75rem;
            border-radius: 8px;
            border-left: 5px solid #4CAF50;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .delete-btn:hover {
            background-color: #c82333;
        }

        /* New styles for prep list management */
        .prep-list-container {
            grid-column: 1 / -1;
            background-color: #f0f0f0;
            border-radius: 5px;
            padding: 1rem;
            margin-top: -1rem;
            margin-bottom: 1rem;
        }

        .prep-list-input {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .prep-list-input input {
            flex-grow: 1;
        }

        .prep-list-input button {
            width: auto;
            grid-column: auto;
            padding: 0.5rem 1rem;
        }

        .prep-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .prep-list li {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: #e6e6e6;
            border-radius: 3px;
            border-left: 3px solid #666;
            font-size: 0.9rem;
        }

        .prep-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .prep-list-item button {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            padding: 0;
        }

        .sort-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }
        
        .report-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .report-tabs button {
            padding: 0.75rem 1.5rem;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #eee;
            cursor: pointer;
        }
        
        .report-tabs button.active-tab {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        #calendar-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 1rem;
        }
        
        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            text-align: center;
        }
        
        .calendar-day {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
        }
        
        .calendar-day.current-month {
            background-color: #fff;
        }
        
        .calendar-day h5 {
            margin: 0;
            font-size: 1.1rem;
            color: #555;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 5px;
        }
        
        .assignment-item {
            font-size: 0.85rem;
            background-color: #e6f3e6;
            color: #333;
            padding: 5px;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
</head>
<body>
    <header>
        <h1>Guest Accommodations Manager</h1>
    </header>

    <nav>
        <button onclick="showSection('dashboard')">Dashboard</button>
        <button onclick="showSection('houses')">Houses</button>
        <button onclick="showSection('rooms')">Rooms</button>
        <button onclick="showSection('guests')">Guests</button>
        <button onclick="showSection('assignments')">Assign Guests</button>
        <button onclick="showSection('reports')">Reports</button>
    </nav>

    <main>
        <!-- Dashboard Section -->
        <section id="dashboard" class="active">
            <h2>Dashboard</h2>
            <div id="dashboard-summary">
                <p>Welcome! Use the navigation bar above to manage your houses, rooms, and guest assignments. All your data is saved securely in the cloud via Firebase.</p>
                <div id="summary-content"></div>
                <div id="user-info"></div>
            </div>
        </section>

        <!-- Houses Section -->
        <section id="houses" class="hidden">
            <h2>Manage Houses</h2>
            <form id="house-form">
                <input type="text" id="house-name" placeholder="House Name" required>
                <button type="submit">Add House</button>
            </form>
            <ul id="house-list"></ul>
        </section>

        <!-- Rooms Section -->
        <section id="rooms" class="hidden">
            <h2>Manage Rooms</h2>
            <form id="room-form">
                <select id="room-house" required>
                    <option value="" disabled selected>Select a House</option>
                </select>
                <input type="text" id="room-name" placeholder="Room Name (e.g., Master Bedroom)" required>
                <input type="number" id="room-capacity" placeholder="Capacity (e.g., 2)" required min="1">
                <input type="text" id="room-bed-type" placeholder="Bed Type (e.g., King, Queen)" required>
                <!-- New UI for adding prep list items -->
                <div class="prep-list-container">
                    <p>Prep Needed:</p>
                    <div class="prep-list-input">
                        <input type="text" id="room-prep-item" placeholder="e.g., Buy new sheets">
                        <button type="button" onclick="addPrepItem()">Add</button>
                    </div>
                    <ul id="prep-list" class="prep-list"></ul>
                </div>
                <!-- End new UI -->
                <button type="submit">Add Room</button>
            </form>
            <!-- Sort controls for the room list -->
            <div class="sort-controls">
                <span>Sort by:</span>
                <button onclick="sortRooms('houseName')">House</button>
                <button onclick="sortRooms('name')">Room</button>
            </div>
            <ul id="room-list"></ul>
        </section>

        <!-- Guests Section -->
        <section id="guests" class="hidden">
            <h2>Manage Guests & Families</h2>
            <form id="guest-form">
                <input type="text" id="guest-name" placeholder="Guest's Name" required>
                <input type="text" id="guest-family" placeholder="Family Name (e.g., Smith Family)">
                <button type="submit">Add Guest</button>
            </form>
            <ul id="guest-list"></ul>
        </section>

        <!-- Assignments Section -->
        <section id="assignments" class="hidden">
            <h2>Assign Guests to Rooms</h2>
            <form id="assignment-form">
                <select id="assignment-house" required>
                    <option value="" disabled selected>Select a House</option>
                </select>
                <select id="assignment-room" required disabled>
                    <option value="" disabled selected>Select a Room</option>
                </select>
                <select id="assignment-guest" required>
                    <option value="" disabled selected>Select a Guest or Family</option>
                </select>
                <label for="assignment-start">Start Date:</label>
                <input type="date" id="assignment-start" required>
                <label for="assignment-end">End Date:</label>
                <input type="date" id="assignment-end" required>
                <button type="submit">Assign</button>
            </form>
            <ul id="assignment-list"></ul>
        </section>

        <!-- Reports Section -->
        <section id="reports" class="hidden">
            <h2>Reports</h2>
            <div class="report-tabs">
                <button onclick="showReportView('list-view')" class="active-tab">List View</button>
                <button onclick="showReportView('calendar-view')">Calendar View</button>
            </div>

            <!-- List View Report -->
            <div id="list-view" class="report-content active-report">
                <h3>All Assignments (List View)</h3>
                <ul id="reports-list"></ul>
            </div>

            <!-- Calendar View Report -->
            <div id="calendar-view" class="report-content hidden-report">
                <h3>Assignments (Calendar View)</h3>
                <div id="calendar-controls">
                    <button onclick="prevMonth()">Prev</button>
                    <h4 id="current-month-year"></h4>
                    <button onclick="nextMonth()">Next</button>
                </div>
                <div id="calendar-grid"></div>
            </div>
        </section>
    </main>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyB_0fHWf0Hrpjcv4Hn0QY4L4JDMpc9RFVc",
            authDomain: "home-guests.firebaseapp.com",
            projectId: "home-guests",
            storageBucket: "home-guests.firebasestorage.app",
            messagingSenderId: "527629164349",
            appId: "1:527629164349:web:6eca4e0ce1020d35f56f54"
        };
        const appId = "home-guests";
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;

        // --- DOM Element References ---
        const sections = document.querySelectorAll('section');
        const houseForm = document.getElementById('house-form');
        const roomForm = document.getElementById('room-form');
        const guestForm = document.getElementById('guest-form');
        const assignmentForm = document.getElementById('assignment-form');
        const houseList = document.getElementById('house-list');
        const roomList = document.getElementById('room-list');
        const guestList = document.getElementById('guest-list');
        const assignmentList = document.getElementById('assignment-list');
        const reportsList = document.getElementById('reports-list');
        const calendarGrid = document.getElementById('calendar-grid');
        const currentMonthYear = document.getElementById('current-month-year');
        const roomHouseSelect = document.getElementById('room-house');
        const assignmentHouseSelect = document.getElementById('assignment-house');
        const assignmentRoomSelect = document.getElementById('assignment-room');
        const assignmentGuestSelect = document.getElementById('assignment-guest');
        const summaryContent = document.getElementById('summary-content');
        const userInfo = document.getElementById('user-info');
        // New DOM elements for prep list
        const roomPrepItemInput = document.getElementById('room-prep-item');
        const prepListUl = document.getElementById('prep-list');

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let tempPrepList = []; // Temporary array to hold prep items before saving a room

        // --- Firebase Auth & Initialization ---
        async function signIn() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error during authentication:", error);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userInfo.innerHTML = `<strong>User ID:</strong> ${userId}`;
                loadData();
            } else {
                console.log("User is signed out.");
                userId = null;
            }
        });

        // --- UI Functions ---
        window.showSection = function(sectionId) {
            sections.forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            if (sectionId === 'reports') {
                renderReports();
                showReportView('list-view');
            }
            if (sectionId === 'dashboard') {
                renderDashboard();
            }
        };

        window.showReportView = function(viewId) {
            document.querySelectorAll('.report-content').forEach(view => {
                view.classList.add('hidden-report');
            });
            document.getElementById(viewId).classList.remove('hidden-report');

            document.querySelectorAll('.report-tabs button').forEach(button => {
                button.classList.remove('active-tab');
            });
            document.querySelector(`button[onclick="showReportView('${viewId}')"]`).classList.add('active-tab');

            if (viewId === 'calendar-view') {
                renderCalendar();
            }
        };

        // --- Firestore CRUD Operations ---
        async function addData(collectionName, data) {
            if (!userId) {
                console.error("User not authenticated.");
                return;
            }
            try {
                const colRef = collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`);
                await addDoc(colRef, data);
                console.log(`Added data to ${collectionName}.`);
            } catch (error) {
                console.error(`Error adding data to ${collectionName}:`, error);
            }
        }

        async function deleteData(collectionName, docId) {
            if (!userId) {
                console.error("User not authenticated.");
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionName}`, docId);
                await deleteDoc(docRef);
                console.log(`Deleted data from ${collectionName}.`);
            } catch (error) {
                console.error(`Error deleting data from ${collectionName}:`, error);
            }
        }

        // --- Data Loading & Real-time Updates ---
        function loadData() {
            if (!userId) return;
            setupRealtimeListeners();
            populateSelects();
            renderDashboard();
        }

        function setupRealtimeListeners() {
            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/houses`), (snapshot) => {
                houseList.innerHTML = '';
                snapshot.forEach(doc => {
                    const item = { id: doc.id, ...doc.data() };
                    const li = document.createElement('li');
                    li.innerHTML = `<span>🏡 ${item.name}</span> <button class="delete-btn" onclick="deleteDataWrapper('houses', '${item.id}')">Delete</button>`;
                    houseList.appendChild(li);
                });
                populateSelects();
            });

            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/rooms`), (snapshot) => {
                const roomsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRooms(roomsData);
                populateSelects();
            });

            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/guests`), (snapshot) => {
                guestList.innerHTML = '';
                snapshot.forEach(doc => {
                    const item = { id: doc.id, ...doc.data() };
                    const li = document.createElement('li');
                    li.innerHTML = `<span>👤 ${item.name} ${item.family ? `(Family: ${item.family})` : ''}</span> <button class="delete-btn" onclick="deleteDataWrapper('guests', '${item.id}')">Delete</button>`;
                    guestList.appendChild(li);
                });
                populateSelects();
            });

            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/assignments`), (snapshot) => {
                assignmentList.innerHTML = '';
                snapshot.forEach(doc => {
                    const item = { id: doc.id, ...doc.data() };
                    const li = document.createElement('li');
                    li.innerHTML = `<span>🗓️ ${item.guestName} staying in ${item.roomName} at ${item.houseName} from ${item.startDate} to ${item.endDate}.</span> <button class="delete-btn" onclick="deleteDataWrapper('assignments', '${item.id}')">Delete</button>`;
                    assignmentList.appendChild(li);
                });
                renderReports();
                renderCalendar();
            });
        }
        
        // Wrapper function for `deleteData` to be used with `onclick`
        window.deleteDataWrapper = function(collectionName, docId) {
            deleteData(collectionName, docId);
        };

        // Function to handle adding a prep item to the temporary list
        window.addPrepItem = function() {
            const item = roomPrepItemInput.value.trim();
            if (item) {
                tempPrepList.push(item);
                roomPrepItemInput.value = '';
                renderTempPrepList();
            }
        };

        // Function to remove a prep item from the temporary list
        window.removePrepItem = function(index) {
            tempPrepList.splice(index, 1);
            renderTempPrepList();
        };

        // Renders the temporary prep list UI
        function renderTempPrepList() {
            prepListUl.innerHTML = '';
            tempPrepList.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'prep-list-item';
                li.innerHTML = `
                    <span>${item}</span>
                    <button type="button" onclick="removePrepItem(${index})">
                        &times;
                    </button>
                `;
                prepListUl.appendChild(li);
            });
        }
        
        // --- Select Element Population ---
        async function populateSelects() {
            if (!userId) return;

            roomHouseSelect.innerHTML = '<option value="" disabled selected>Select a House</option>';
            assignmentHouseSelect.innerHTML = '<option value="" disabled selected>Select a House</option>';
            assignmentRoomSelect.innerHTML = '<option value="" disabled selected>Select a Room</option>';
            assignmentGuestSelect.innerHTML = '<option value="" disabled selected>Select a Guest or Family</option>';
            assignmentRoomSelect.disabled = true;

            try {
                // Populate Houses
                const housesSnap = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/houses`));
                housesSnap.forEach(doc => {
                    const house = { id: doc.id, ...doc.data() };
                    const option1 = new Option(house.name, house.id);
                    const option2 = new Option(house.name, house.id);
                    roomHouseSelect.add(option1);
                    assignmentHouseSelect.add(option2);
                });

                // Populate Guests
                const guestsSnap = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/guests`));
                guestsSnap.forEach(doc => {
                    const guest = { id: doc.id, ...doc.data() };
                    const option = new Option(guest.family || guest.name, guest.id);
                    assignmentGuestSelect.add(option);
                });
            } catch (error) {
                console.error("Error populating selects:", error);
            }
        }

        // --- Event Listeners ---
        houseForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('house-name').value;
            addData('houses', { name });
            e.target.reset();
        });

        roomForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const houseId = document.getElementById('room-house').value;
            const name = document.getElementById('room-name').value;
            const capacity = parseInt(document.getElementById('room-capacity').value);
            const bedType = document.getElementById('room-bed-type').value;

            try {
                const housesSnap = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/houses`));
                const house = housesSnap.docs.find(doc => doc.id === houseId)?.data();
                if (house) {
                    addData('rooms', { houseId, houseName: house.name, name, capacity, bedType, prepNeeded: tempPrepList });
                    e.target.reset();
                    tempPrepList = []; // Reset the temporary list
                    renderTempPrepList();
                    document.getElementById('room-house').value = "";
                }
            } catch (error) {
                console.error("Error adding room:", error);
            }
        });

        guestForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('guest-name').value;
            const family = document.getElementById('guest-family').value;
            addData('guests', { name, family });
            e.target.reset();
        });

        assignmentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const houseId = document.getElementById('assignment-house').value;
            const roomId = document.getElementById('assignment-room').value;
            const guestId = document.getElementById('assignment-guest').value;
            const startDate = document.getElementById('assignment-start').value;
            const endDate = document.getElementById('assignment-end').value;

            try {
                const roomsSnap = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/rooms`));
                const guestsSnap = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/guests`));

                const room = roomsSnap.docs.find(doc => doc.id === roomId)?.data();
                const guest = guestsSnap.docs.find(doc => doc.id === guestId)?.data();

                if (room && guest) {
                    addData('assignments', { houseId, houseName: room.houseName, roomId, roomName: room.name, guestId, guestName: guest.name, startDate, endDate });
                    e.target.reset();
                    assignmentRoomSelect.disabled = true;
                    assignmentRoomSelect.innerHTML = '<option value="" disabled selected>Select a Room</option>';
                }
            } catch (error) {
                console.error("Error adding assignment:", error);
            }
        });

        assignmentHouseSelect.addEventListener('change', async (e) => {
            const houseId = e.target.value;
            assignmentRoomSelect.disabled = false;
            assignmentRoomSelect.innerHTML = '<option value="" disabled selected>Select a Room</option>';

            try {
                const roomsSnap = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/rooms`));
                roomsSnap.forEach(doc => {
                    const room = { id: doc.id, ...doc.data() };
                    if (room.houseId === houseId) {
                        const option = new Option(room.name, room.id);
                        assignmentRoomSelect.add(option);
                    }
                });
            } catch (error) {
                console.error("Error populating rooms:", error);
            }
        });
        
        // --- Room List Rendering and Sorting ---
        let currentRoomsData = [];

        async function renderRooms(roomsData) {
            currentRoomsData = roomsData;
            sortRooms('houseName'); // Default sort
        }

        window.sortRooms = function(sortBy) {
            roomList.innerHTML = '';
            
            let sortedData = [...currentRoomsData];

            if (sortBy === 'houseName') {
                sortedData.sort((a, b) => a.houseName.localeCompare(b.houseName) || a.name.localeCompare(b.name));
            } else if (sortBy === 'name') {
                sortedData.sort((a, b) => a.name.localeCompare(b.name) || a.houseName.localeCompare(b.houseName));
            }
            
            sortedData.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>
                        🚪 ${item.name} (${item.houseName}) - Capacity: ${item.capacity}, Bed: ${item.bedType}
                        ${item.prepNeeded && item.prepNeeded.length > 0 ? `
                        <br><strong>Prep Needed:</strong>
                        <ul>${item.prepNeeded.map(prep => `<li>${prep}</li>`).join('')}</ul>
                        ` : ''}
                    </span>
                    <button class="delete-btn" onclick="deleteDataWrapper('rooms', '${item.id}')">Delete</button>
                `;
                roomList.appendChild(li);
            });
        };

        // --- Reporting Functions ---
        async function renderDashboard() {
            if (!userId) return;
            try {
                const houseCount = (await getDocs(collection(db, `artifacts/${appId}/users/${userId}/houses`))).size;
                const roomCount = (await getDocs(collection(db, `artifacts/${appId}/users/${userId}/rooms`))).size;
                const guestCount = (await getDocs(collection(db, `artifacts/${appId}/users/${userId}/guests`))).size;
                const assignmentCount = (await getDocs(collection(db, `artifacts/${appId}/users/${userId}/assignments`))).size;

                summaryContent.innerHTML = `
                    <p><strong>Total Houses:</strong> ${houseCount}</p>
                    <p><strong>Total Rooms:</strong> ${roomCount}</p>
                    <p><strong>Total Guests:</strong> ${guestCount}</p>
                    <p><strong>Active Assignments:</strong> ${assignmentCount}</p>
                `;
            } catch (error) {
                console.error("Error rendering dashboard:", error);
            }
        }

        async function renderReports() {
            if (!userId) return;
            reportsList.innerHTML = '';
            try {
                const assignmentsSnap = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/assignments`));
                const assignments = assignmentsSnap.docs.map(doc => doc.data());
                assignments.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                assignments.forEach(assignment => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${assignment.guestName}</strong> in <strong>${assignment.roomName}</strong> at <strong>${assignment.houseName}</strong> from ${assignment.startDate} to ${assignment.endDate}.`;
                    reportsList.appendChild(li);
                });
            } catch (error) {
                console.error("Error rendering reports:", error);
            }
        }

        async function renderCalendar() {
            if (!userId) return;
            calendarGrid.innerHTML = '';
            currentMonthYear.textContent = `${new Date(currentYear, currentMonth).toLocaleString('default', { month: 'long' })} ${currentYear}`;

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            // Fill in leading empty days
            for (let i = 0; i < firstDay; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('calendar-day');
                calendarGrid.appendChild(dayDiv);
            }

            try {
                const assignmentsSnap = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/assignments`));
                const assignments = assignmentsSnap.docs.map(doc => doc.data());

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.classList.add('calendar-day', 'current-month');
                    const dayNum = document.createElement('h5');
                    dayNum.textContent = i;
                    dayDiv.appendChild(dayNum);

                    const currentDate = new Date(currentYear, currentMonth, i).toISOString().split('T')[0];

                    assignments.forEach(assignment => {
                        if (currentDate >= assignment.startDate && currentDate <= assignment.endDate) {
                            const assignmentItem = document.createElement('div');
                            assignmentItem.classList.add('assignment-item');
                            assignmentItem.textContent = `${assignment.guestName} (${assignment.roomName})`;
                            dayDiv.appendChild(assignmentItem);
                        }
                    });
                    calendarGrid.appendChild(dayDiv);
                }
            } catch (error) {
                console.error("Error rendering calendar:", error);
            }
        }

        window.prevMonth = function() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        };

        window.nextMonth = function() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        };

        // --- Start the App ---
        window.onload = signIn;
    </script>
</body>
</html>
